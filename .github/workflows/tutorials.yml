name: Tutorials

on:
  # Activate this workflow manually
  workflow_dispatch:
  # Activate this workflow on every push of code changes on master
  push:
    branches:
      - master
    paths:
      - '**/*.py'
      - '**/*.ipynb'

jobs:

  tutorials:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

    - name: Set up Python 3.7
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Cache Python
      uses: actions/cache@v2
      with:
        path: ${{ env.pythonLocation }}
        key: linux-${{ env.date }}-${{ hashFiles('**/setup.py') }}-${{ hashFiles('**/setup.cfg') }}-${{ hashFiles('**/pyproject.toml') }}

    - name: Install pdftotext
      run: wget --no-check-certificate https://dl.xpdfreader.com/xpdf-tools-linux-4.04.tar.gz && tar -xvf xpdf-tools-linux-4.04.tar.gz && sudo cp xpdf-tools-linux-4.04/bin64/pdftotext /usr/local/bin

    - name: Install Dependencies (on cache miss only)
      # The cache might miss during the execution of an action: there should always be a fallback step to
      # rebuild it in case it goes missing
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip
        pip install .[all]
        pip install rest_api/
        pip install ui/
        pip install torch-scatter -f https://data.pyg.org/whl/torch-1.11.0+cpu.html

    # Haystack needs to be reinstalled at this stage to make sure the current commit's version is the one getting tested.
    # The cache can last way longer than a specific action's run, so older Haystack version could be carried over.
    - name: Reinstall Haystack
      run: |
        pip install .[all]

    - name: Run Notebook Tutorials
      run: |
        set -e   # Fails on any error in the following loop
        for file in tutorials/*.ipynb ; do
          echo "Processing" $file
          ipython -c "%run tutorials/Tutorial1_Basic_QA_Pipeline.ipynb"
        done


  scripts:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

    - name: Set up Python 3.7
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Cache Python
      uses: actions/cache@v2
      with:
        path: ${{ env.pythonLocation }}
        key: linux-${{ env.date }}-${{ hashFiles('**/setup.py') }}-${{ hashFiles('**/setup.cfg') }}-${{ hashFiles('**/pyproject.toml') }}

    - name: Install pdftotext
      run: wget --no-check-certificate https://dl.xpdfreader.com/xpdf-tools-linux-4.04.tar.gz && tar -xvf xpdf-tools-linux-4.04.tar.gz && sudo cp xpdf-tools-linux-4.04/bin64/pdftotext /usr/local/bin

    - name: Install Dependencies (on cache miss only)
      # The cache might miss during the execution of an action: there should always be a fallback step to
      # rebuild it in case it goes missing
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip
        pip install .[all]
        pip install rest_api/
        pip install ui/
        pip install torch-scatter -f https://data.pyg.org/whl/torch-1.11.0+cpu.html

    # Haystack needs to be reinstalled at this stage to make sure the current commit's version is the one getting tested.
    # The cache can last way longer than a specific action's run, so older Haystack version could be carried over.
    - name: Reinstall Haystack
      run: |
        pip install .[all]
    
    - name: Run Python Tutorials
      run: |
        set -e   # Fails on any error in the following loop
        for file in tutorials/*.py ; do
          echo "Processing" $file
          python $file
        done
